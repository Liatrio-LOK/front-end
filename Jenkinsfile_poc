#!groovy
podTemplate(label: 'slave-pod', cloud: 'openshift', containers: [
        containerTemplate(name: 'node', image: 'node', ttyEnabled: true, command: 'cat'),
]) {
    node {
        minishift_ip = env.MINISHIFT_IP
    }
    node('slave-pod') {
        stage('Build Image') {
            openshiftBuild(
                    namespace: 'jenkins',
                    bldCfg: 'front-end-build',
                    checkForTriggeredDeployments: 'true',
                    showBuildLogs: 'true',
                    verbose: 'false'
            )
        }
        stage('Verify Build') {
            openshiftVerifyBuild(
                    namespace: 'jenkins',
                    bldCfg: 'front-end-build',
                    checkForTriggeredDeployments: 'true',
                    verbose: 'true'
            )
        }
        stage('Deploy to Dev') {
            openshiftTag(
                    srcStream: 'front-end',
                    srcTag: 'latest',
                    destinationStream: 'front-end',
                    destinationTag: 'dev',
                    destinationNamespace: 'dev'
            )
        }
        stage('Cucumber acceptance testing') {
            checkout scm
            container('node') {
                stage('run tests') {
                    sh 'npm install'
                    sh "./node_modules/.bin/cucumber-js ./test/cucumber/features -r ./test/cucumber/step_definitions ${minishift_ip} 30011"
                    input 'promote image?'
                }
            }
        }

        stage('Promote to Prod') {
            openshiftTag(
                    srcStream: 'front-end',
                    srcTag: 'dev',
                    namespace: 'dev',
                    destinationStream: 'front-end',
                    destinationTag: 'prod',
                    destinationNamespace: 'prod'
            )
        }
        stage('Smoke test Prod') {
            container('selenium') {
                stage('run test') {
                    sh 'sleep 5'
                    sh "ruby front-end-test-grid.rb ${minishift_ip} 30014"
                }
            }
        }
    }
}
